c4_codes <- c("maize")
# get the polygons with x pct wheat
winterwheat_sf <- result_all[idx,]
winterwheat_sf <- winterwheat_sf %>%
mutate(
wheat_share = purrr::map_dbl(crop_stats, function(cs) {
wheat_row <- cs[cs$code == "winter_wheat", ]
wheat_pct <- wheat_row$area_pct
total_pct <- sum(cs$area_pct)
wheat_pct / total_pct
}),
c3_share = purrr::map_dbl(crop_stats, function(cs) {
# total crop pct inside polygon
total_pct <- sum(cs$area_pct)
# sum of area_pct for all C3 crops
c3_pct <- sum(cs$area_pct[cs$code %!in% c4_codes])
# normalized C3 fraction
c3_pct / total_pct
})
)
View(winterwheat_sf)
head(winterwheat_sf,1)
winterwheat_sf %>%
st_drop_geometry() %>%
select(Daily_SIF_740nm, wheat_share,c3_share,Meteo.vapor_pressure_deficit) %>%
pivot_longer(cols = everything(),names_to = "variable",values_to = "value") %>%
ggplot(aes(x = value)) +
geom_density(na.rm = TRUE) +
facet_wrap(~ variable, scales = "free") +
theme_minimal()
winterwheat_sf %>%
st_drop_geometry() %>%
select(Daily_SIF_740nm, wheat_share,c3_share,Meteo.vapor_pressure_deficit) %>%
pivot_longer(cols = everything(),names_to = "variable",values_to = "value") %>%
ggplot(aes(x = value)) +
geom_density(na.rm = TRUE) +
facet_wrap(~ variable, scales = "free") +
theme_bw()
#---------------------------MODELLING-------------------------------------------
sif_monthly <- as.data.frame(winterwheat_sf) |>
mutate(
year = year(Delta_date),
month = month(Delta_date, label = TRUE, abbr = TRUE)
) |>
filter(year %in% 2017:2024, month(Delta_date) %in% 2:5) |>
group_by(NUTS_NAME, year, month) |>
summarise(
mean_sif         = mean(Daily_SIF_740nm, na.rm = TRUE),
mean_humidity    = mean(Meteo.specific_humidity, na.rm = TRUE),
mean_pressure    = mean(Meteo.surface_pressure, na.rm = TRUE),
mean_temp_skin   = mean(Meteo.temperature_skin, na.rm = TRUE),
mean_temp_2m     = mean(Meteo.temperature_two_meter, na.rm = TRUE),
mean_vpd         = mean(Meteo.vapor_pressure_deficit, na.rm = TRUE),
mean_c3_share    = mean(c3_share, na.rm = TRUE),
.groups = "drop"
)
View(sif_monthly)
X_all <- sif_monthly %>%
mutate(month = as.character(month)) %>%
pivot_wider(
names_from = month,
values_from = c(
mean_sif, mean_humidity, mean_pressure,
mean_temp_skin, mean_temp_2m, mean_vpd, mean_c3_share
),
names_glue = "{.value}_{month}"
)
View(X_all)
head(X_all)
colSums(is.na(df))
colSums(is.na(X_all))
sort(colSums(is.na(X_all)))
#---------------------------MODELLING-------------------------------------------
sif_monthly <- as.data.frame(winterwheat_sf) |>
mutate(
year = year(Delta_date),
month = month(Delta_date, label = TRUE, abbr = TRUE)
) |>
filter(year %in% 2017:2024, month(Delta_date) %in% 2:7) |>
group_by(NUTS_NAME, year, month) |>
summarise(
mean_sif         = mean(Daily_SIF_740nm, na.rm = TRUE),
mean_humidity    = mean(Meteo.specific_humidity, na.rm = TRUE),
mean_pressure    = mean(Meteo.surface_pressure, na.rm = TRUE),
mean_temp_skin   = mean(Meteo.temperature_skin, na.rm = TRUE),
mean_temp_2m     = mean(Meteo.temperature_two_meter, na.rm = TRUE),
mean_vpd         = mean(Meteo.vapor_pressure_deficit, na.rm = TRUE),
mean_c3_share    = mean(c3_share, na.rm = TRUE),
.groups = "drop"
)
#---------------------------MODELLING-------------------------------------------
sif_monthly <- as.data.frame(winterwheat_sf) |>
mutate(
year = year(Delta_date),
month = month(Delta_date, label = TRUE, abbr = TRUE)
) |>
filter(year %in% 2017:2024, month(Delta_date) %in% 3:7) |>
group_by(NUTS_NAME, year, month) |>
summarise(
mean_sif         = mean(Daily_SIF_740nm, na.rm = TRUE),
mean_humidity    = mean(Meteo.specific_humidity, na.rm = TRUE),
mean_pressure    = mean(Meteo.surface_pressure, na.rm = TRUE),
mean_temp_skin   = mean(Meteo.temperature_skin, na.rm = TRUE),
mean_temp_2m     = mean(Meteo.temperature_two_meter, na.rm = TRUE),
mean_vpd         = mean(Meteo.vapor_pressure_deficit, na.rm = TRUE),
mean_c3_share    = mean(c3_share, na.rm = TRUE),
.groups = "drop"
)
X_all <- sif_monthly %>%
mutate(month = as.character(month)) %>%
pivot_wider(
names_from = month,
values_from = c(
mean_sif, mean_humidity, mean_pressure,
mean_temp_skin, mean_temp_2m, mean_vpd, mean_c3_share
),
names_glue = "{.value}_{month}"
)
View(X_all)
sort(colSums(is.na(X_all)))
# List all CSV files in the folder
files <- list.files("../data/bayern_yield_formatted/", pattern = "\\.csv$", full.names = TRUE)
target_nuts <- c("Mittelfranken", "Niederbayern", "Oberbayern", "Oberfranken", "Oberpfalz", "Schwaben", "Unterfranken")
# clean column names
clean_names1 <- function(x) {
x <- iconv(x, from = "", to = "UTF-8")
x <- gsub("\\s+", " ", x)
trimws(x)
}
Y_all <- lapply(files, function(f) {
#f <- "../data/bayern_yield_formatted/2016.csv"
year <- as.numeric(str_extract(basename(f), "\\d{4}"))
y <- read.csv(f, sep = ";", fileEncoding = "latin1", stringsAsFactors = FALSE)
y <- y |> mutate(name = clean_names1(name))
names(y) <- make.names(names(y))
y <- y |>
filter(name %in% target_nuts) |>
select(name, Winterweizen) |>
mutate(year = year)
return(y)
}) |>
bind_rows()
# (German decimals use commas)
Y_all <- Y_all |> mutate(Winterweizen = as.numeric(gsub(",", ".", Winterweizen)))
XY_all <- X_all |> inner_join(Y_all, by = c("NUTS_NAME" = "name", "year" = "year"))
XY_all$Winterweizen <- XY_all$Winterweizen/10
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
View(train_df)
View(test_df)
head(train_df)
sort(colSums(is.na(X_all)))
sort(colSums(is.na(train_df))
)
ini  <- mice(train_df, maxit = 0, printFlag = FALSE)
ini
methM <- ini$method
pred <- ini$predictorMatrix
head(train_df)
train_df <- train_df %>%
mutate(
NUTS_NAME = factor(NUTS_NAME),
year      = factor(year)
)
head(train_df)
ini  <- mice(train_df, maxit = 0, printFlag = FALSE)
methM <- ini$method
pred <- ini$predictorMatrix
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
train_df <- train_df %>%
mutate(
NUTS_NAME = factor(NUTS_NAME),
year      = factor(year)
)
ini  <- mice(train_df, maxit = 0, printFlag = FALSE)
methM <- ini$method
pred <- ini$predictorMatrix
# which variables NOT to impute (but still use as predictors)
methM["NUTS_NAME"]    <- ""
methM["year"]         <- ""
methM["Winterweizen"] <- ""
pred["NUTS_NAME", ]    <- 0
pred["year", ]         <- 0
pred["Winterweizen", ] <- 0
imp <- mice(
train_df,
m              = 5,
method         = methM,
predictorMatrix = pred,
seed           = 123
)
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
train_df <- train_df %>%
mutate(
NUTS_NAME = factor(NUTS_NAME),
year      = factor(year)
)
imp <- mice(
train_df,
m              = 5,
#method         = methM,
#predictorMatrix = pred,
seed           = 123
)
View(XY_all)
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
train_df <- train_df %>%
mutate(
NUTS_NAME = factor(NUTS_NAME),
year      = factor(year)
)
#------------------------------IMPUTATION---------------------------------------
ini  <- mice(train_df, maxit = 0, printFlag = FALSE)
methM <- ini$method
pred <- ini$predictorMatrix
# which variables NOT to impute (but still use as predictors)
methM["NUTS_NAME"]    <- ""
methM["year"]         <- ""
methM["Winterweizen"] <- ""
pred["NUTS_NAME", ]    <- 0
pred["year", ]         <- 0
pred["Winterweizen", ] <- 0
pred["mean_sif_Mar", ] <- 0
pred["mean_sif_Mar", c(
"year",
"NUTS_NAME",
"mean_sif_Apr",
"mean_sif_May",
"mean_sif_Jun",
"mean_sif_Jul",
"Winterweizen"
)] <- 1
imp <- mice(
train_df,
m              = 5,
method         = methM,
predictorMatrix = pred,
ridge           = 1e-05,
seed           = 123
)
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
md.pattern(train_df)
?md.pattern
md.pattern(train_df, rotate.names = TRUE)
imp <- mice(train_df,m=5,maxit=50,meth='pmm',seed=123)
summary(imp)
imp$meth
test_df[, -c(1,2)]
ncol(test_df)
test_df[, -c(1,2,38)]
train_complete <- complete(imp,1)
# linear regression
model <- lm(Winterweizen ~ ., data = train_complete[, -c(1,2)])
# model summary
summary(model)
train_complete[, -c(1,2)]
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df[, -c(1,2,38)])
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield)
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
rmse
test_df
View(test_df)
head(train_complete)
head(train_complete[, -c(1,2)])
test_df  <- XY_all |> filter(year == 2024)
head(test_df)
head(test_df[, -c(1,2)])
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
sort(colSums(is.na(train_df)))
nrow(train_df)
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
train_df_mean_imp <- train_df %>%
mutate(
across(
where(is.numeric),
~ ifelse(is.na(.), mean(., na.rm = TRUE), .)
)
)
View(train_df_mean_imp)
#----------------------------------linear regression----------------------------
model <- lm(Winterweizen ~ ., data = train_df_mean_imp[, -c(1,2)])
# model summary
summary(model)
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df[, -c(1,2,38)])
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield)
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
#----------------------------------linear regression----------------------------
model <- lm(Winterweizen ~ ., data = train_complete[, -c(1,2)])
# model summary
summary(model)
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df[, -c(1,2,38)])
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield)
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield, pct_diff)
colnames(train_complete)
#----------------------------------linear regression----------------------------
fmla <- .
model <- lm(Winterweizen ~ fmla, data = train_complete[, -c(1,2)])
#----------------------------------linear regression----------------------------
fmla <- Yield ~ sif_feb + sif_mar + sif_apr + sif_may
colnames(train_complete)
# model summary
summary(model)
colnames(train_complete)
#----------------------------------linear regression----------------------------
fmla <- Winterweizen ~ mean_sif_Mar + mean_sif_Apr + mean_sif_May + mean_sif_Jun +
mean_sif_Jul + mean_c3_share_Mar + mean_c3_share_Apr + mean_c3_share_May + mean_c3_share_Jun +
mean_c3_share_Jul + mean_temp_2m_Mar + mean_temp_2m_Apr + mean_temp_2m_May + mean_temp_2m_Jun +
mean_temp_2m_Jul
model <- lm(fmla, data = train_complete[, -c(1,2)])
# model summary
summary(model)
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df[, -c(1,2,38)])
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield, pct_diff)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df)
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield, pct_diff)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
#----------------------------------glmnet----------------------------
library(glmnet)
library(tidyverse)
library(mice)
X <- model.matrix(Winterweizen ~ ., data = train_complete)[, -1]  # drop intercept column
X
X <- model.matrix(Winterweizen ~ ., data = train_complete)[, -1]  # drop intercept column
y <- train_complete$Winterweizen
set.seed(123)
cv_fit <- cv.glmnet(
x      = X,
y      = y,
alpha  = 1,      # 1 = lasso, 0 = ridge, in between = elastic net
nfolds = 5       # you can use 10, but with ~50 obs 5 is fine
)
## 5. Inspect results
plot(cv_fit)                           # CV curve vs log(lambda)
cv_fit$lambda.min                      # lambda with minimum CV error
cv_fit$lambda.1se                      # more regularized lambda
## 6. Coefficients at best lambda
coef_min  <- coef(cv_fit, s = "lambda.min")
coef_1se  <- coef(cv_fit, s = "lambda.1se")
coef_min
coef_1se
train_complete
glm_train <- train_complete %>% select(-c(NUTS_NAME, year))
X <- model.matrix(Winterweizen ~ ., data = glm_train)[, -1]  # drop intercept column
y <- train_complete$Winterweizen
X
set.seed(123)
cv_fit <- cv.glmnet(
x      = X,
y      = y,
alpha  = 1,      # 1 = lasso, 0 = ridge, in between = elastic net
nfolds = 5       # you can use 10, but with ~50 obs 5 is fine
)
## 5. Inspect results
plot(cv_fit)                           # CV curve vs log(lambda)
glm_test <- test_df %>% select(-c(NUTS_NAME, year))
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
X_test
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
test_df  <- XY_all |> filter(year == 2024)
glm_test <- test_df %>% select(-c(NUTS_NAME, year))
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
test_df %>% mutate(pred_Winterweizen = as.numeric(y_pred))
test_df %>% mutate(pred_Winterweizen = as.numeric(y_pred)) %>% select(NUTS_NAME, pred_Winterweizen, Winterweizen)
test_df %>% mutate(
pred_Winterweizen = as.numeric(y_pred),
pct_diff = 100 * (pred_Winterweizen - Winterweizen) / Winterweizen) %>%
select(NUTS_NAME, pred_Winterweizen, Winterweizen, pct_diff)
test_df <- test_df %>% mutate(
pred_Winterweizen = as.numeric(y_pred),
pct_diff = 100 * (pred_Winterweizen - Winterweizen) / Winterweizen) %>%
select(NUTS_NAME, pred_Winterweizen, Winterweizen, pct_diff)
rmse <- sqrt(mean((test_df$pred_Winterweizen - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$pred_Winterweizen - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
rmse
library(tidyverse)
library(terra)
library(sf)
library(rnaturalearth)
ndvi <- rast("../data/copernicus_ndvi_300m/NDVI_20250201T000000Z.tif")
nuts1_de <- giscoR::gisco_get_nuts(
year    = "2021",
epsg    = 4326,
resolution = "3",
nuts_level = 1,
country = "DE"
)
nuts1_de <- st_transform(nuts1_de, crs(ndvi))
nuts2_de <- giscoR::gisco_get_nuts(
year    = "2021",
epsg    = 4326,
resolution = "3",
nuts_level = 2,
country = "DE"
)
nuts2_de <- st_transform(nuts2_de, crs(ndvi))
tile_vec <- c(
"32UNA", "32UPA", "32UQA",
"32UNV", "32UPV", "32UQV", "33UUQ",
"32UNU", "32UPU", "32UQU", "33UUP",
"32TNT", "32TPT", "32TQT"
)
base_dir <- "../data/sentinel-2-tiles/"
b4_files <- list.files(base_dir, pattern = "FRC_B4\\.tif$", full.names = TRUE, recursive = TRUE)
length(b4_files)
common_crs <- 4326  # EPSG:3035 / 4326
bbox_list <- lapply(b4_files, function(f) {
r <- terra::rast(f)
ext <- terra::ext(r)
poly <- terra::as.polygons(ext, crs = terra::crs(r))
sf_poly <- sf::st_as_sf(poly)
sf_poly <- sf::st_transform(sf_poly, common_crs)
sf_poly$tile_file <- basename(f)
sf_poly$tile_id   <- sub(".*_L3A_T(.*)_C.*", "\\1", sf_poly$tile_file)
sf_poly
})
tiles_sf <- do.call(rbind, bbox_list)
tiles_sf$tile_id <- factor(tiles_sf$tile_id, levels = tile_vec)
tiles_sf <- tiles_sf[order(tiles_sf$tile_id), ]
target_crs <- st_crs(tiles_sf)
nuts1_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 1,
resolution = "01", country = "DE")
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 3,
resolution = "01", country = "DE")
nuts2_centroids <- sf::st_centroid(nuts2_de)
# nuts1_de <- st_transform(nuts1_de, target_crs)
View(tiles_sf)
View(nuts1_de)
View(nuts2_de)
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_sf(data = tiles_sf, aes(color = tile_id, fill = tile_id), linewidth = 0.8, alpha = 0.3 ) +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
theme_minimal() +
labs(title = "14 tiles covering bavaria", x = "Lon", y = "Lat") +
# --- labels for NUTS level 3 ---
geom_sf_text(
data = nuts2_centroids,
aes(label = NUTS_ID),   # or NUTS_NAME, depending on the column you want
size = 2.5,
check_overlap = TRUE
) +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
theme_minimal() +
labs(
title = "14 tiles covering Bavaria",
x = "Lon",
y = "Lat"
)
