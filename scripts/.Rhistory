arrow = arrow(length = unit(0.25, "cm")),
linewidth = 0.8
) +
# Label with ID and % coverage
geom_label(
aes(x = label_x + 1, y = label_y + 0.1,
label = paste0(max_region$NUTS3_ID, "\n", round(max_region$coverage_pct), "%")),
fill = "white", label.size = 0.3, size = 3) +
coord_sf() +
theme_minimal() +
labs(
title = "OCO-2 SIF Coverage: NUTS3 Regions (2017–2024, Feb–Jul)",
subtitle = "Arrow marks region with highest % spatiotemporal coverage"
)
ggplot(nuts3_map) +
geom_sf(aes(fill = coverage_pct), color = NA) +
scale_fill_viridis_c(
name   = "SIF coverage\n(%)",
limits = c(0, 100)
) +
# Arrow pointing to region centroid
geom_segment(
aes(
x = label_x + 1,
y = label_y + 0.1,
xend = label_x - 0.1,
yend = label_y - 0.1),
arrow = arrow(length = unit(0.25, "cm")),
linewidth = 0.8
) +
# Label with ID and % coverage
geom_label(
aes(x = label_x + 1, y = label_y + 0.1,
label = paste0(max_region$NUTS3_ID, "\n", round(max_region$coverage_pct), "%")),
fill = "white", label.size = 0.3, size = 3) +
coord_sf() +
theme_minimal() +
labs(
x = 'Lon', y = 'Lat',
title = "OCO-2 SIF Coverage: NUTS3 Regions (2017–2024, Feb–Jul)",
subtitle = "Color shows % of month–year combinations with at least one sounding"
)
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 2, resolution = "01", country = "DE")
nuts3_bavaria <- nuts2_de |> filter(startsWith(NUTS_ID, "DE2"))
View(nuts3_bavaria)
nuts3_bavaria <- nuts3_bavaria |> select(NUTS3_ID = NUTS_ID, NUTS3_NAME = NUTS_NAME)
# Start from attribute table only
ww_attr <- winterwheat_sf |>
st_drop_geometry()
ww_attr
coverage_nuts3_heatmap <- ww_attr |>
# keep only the relevant period & months
filter(
dplyr::between(year, 2017, 2023),
month %in% 2:7
) |>
# unique NUTS3–year–month combos
#distinct(NUTS3_ID, NUTS3_NAME, year, month) |>
distinct(NUTS_NAME, year, month) |>
# count number of month-year combos with data per NUTS3
#count(NUTS3_ID, NUTS3_NAME, name = "n_months_with_data") |>
count(NUTS_NAME, name = "n_months_with_data") |>
mutate(
total_possible = 8 * 6,                             # 2017–2024, months 2–7
coverage_pct   = 100 * n_months_with_data / total_possible
)
View(coverage_nuts3_heatmap)
a
coverage_nuts3_heatmap <- ww_attr |>
# keep only the relevant period & months
filter(
dplyr::between(year, 2017, 2024),
month %in% 2:7
) |>
# unique NUTS3–year–month combos
#distinct(NUTS3_ID, NUTS3_NAME, year, month) |>
distinct(NUTS_NAME, year, month) |>
# count number of month-year combos with data per NUTS3
#count(NUTS3_ID, NUTS3_NAME, name = "n_months_with_data") |>
count(NUTS_NAME, name = "n_months_with_data") |>
mutate(
total_possible = 8 * 6,                             # 2017–2024, months 2–7
coverage_pct   = 100 * n_months_with_data / total_possible
)
coverage_nuts3_heatmap <- ww_attr |>
# keep only the relevant period & months
filter(
dplyr::between(year, 2017, 2023),
month %in% 2:7
) |>
# unique NUTS3–year–month combos
#distinct(NUTS3_ID, NUTS3_NAME, year, month) |>
distinct(NUTS_NAME, year, month) |>
# count number of month-year combos with data per NUTS3
#count(NUTS3_ID, NUTS3_NAME, name = "n_months_with_data") |>
count(NUTS_NAME, name = "n_months_with_data") |>
mutate(
total_possible = 8 * 6,                             # 2017–2024, months 2–7
coverage_pct   = 100 * n_months_with_data / total_possible
)
nuts3_bavaria
nuts3_map <- nuts3_bavaria |>
#left_join(coverage_nuts3_heatmap, by = c("NUTS3_ID" = "NUTS3_ID")) |>
left_join(coverage_nuts3_heatmap, by = c("NUTS_NAME" = "NUTS3_NAME")) |>
# NUTS3 with no data at all → 0% coverage
mutate(
coverage_pct = replace_na(coverage_pct, 0)
)
coverage_nuts3_heatmap
nuts3_map <- nuts3_bavaria |>
#left_join(coverage_nuts3_heatmap, by = c("NUTS3_ID" = "NUTS3_ID")) |>
left_join(coverage_nuts3_heatmap, by = c("NUTS3_NAME" = "NUTS_NAME")) |>
# NUTS3 with no data at all → 0% coverage
mutate(
coverage_pct = replace_na(coverage_pct, 0)
)
nuts3_map
ggplot(nuts3_map) +
geom_sf(aes(fill = coverage_pct), color = NA) +
scale_fill_viridis_c(
name   = "SIF coverage\n(%)",
limits = c(0, 100)
) +
coord_sf() +
theme_minimal() +
labs(
#title    = "OCO-2 SIF Coverage: NUTS3 Regions (2017–2024, Feb–Jul)",
title    = "OCO-2 SIF Coverage: NUTS2 Regions (2017–2023, Feb–Jul)",
subtitle = "Color shows % of month–year combinations with at least one sounding"
)
nuts2_centroids
nuts2_centroids <- sf::st_centroid(nuts2_de)
nuts2_centroids
ggplot(nuts3_map) +
geom_sf(aes(fill = coverage_pct), color = NA) +
geom_text(
data = nuts2_centroids,
aes(x = lon, y = lat, label = paste0(round(coverage_pct), "%")),
size = 3,
color = "black"
)
head(nuts2_centroids)
head(nuts2_centroids,1)
centers <- st_coordinates(nuts2_centroids)
nuts2_centroids_df <- nuts2_centroids |>
st_drop_geometry() |>
mutate(lon = centers[, "X"], lat = centers[, "Y"])
nuts2_centroids_df
ggplot(nuts3_map) +
geom_sf(aes(fill = coverage_pct), color = NA) +
geom_text(
data = nuts2_centroids_df,
aes(x = lon, y = lat, label = paste0(round(coverage_pct), "%")),
size = 3,
color = "black"
)
ggplot(nuts3_map) +
geom_sf(aes(fill = coverage_pct), color = NA) +
scale_fill_viridis_c(
name   = "SIF coverage\n(%)",
limits = c(0, 100)
) +
coord_sf() +
theme_minimal() +
labs(
#title    = "OCO-2 SIF Coverage: NUTS3 Regions (2017–2024, Feb–Jul)",
title    = "OCO-2 SIF Coverage: NUTS2 Regions (2017–2023, Feb–Jul)",
subtitle = "Color shows % of month–year combinations with at least one sounding"
)
library(tidyverse)
library(sf)
library(mice)
result_all <- readRDS(file = '../data/model_data.rds')
idx <- sapply(result_all$crop_stats, function(df) {
if (is.null(df) || nrow(df) == 0) return(FALSE)
any(df$code == "winter_wheat" & df$area_pct >= 0, na.rm = TRUE)
})
winterwheat_sf <- result_all[idx,]
c4_codes <- c("maize")
`%!in%` <- Negate(`%in%`)
winterwheat_sf <- winterwheat_sf |>
mutate(
wheat_share = purrr::map_dbl(crop_stats, function(cs) {
wheat_row <- cs[cs$code == "winter_wheat", ]
wheat_pct <- wheat_row$area_pct
total_pct <- sum(cs$area_pct)
wheat_pct / total_pct
}),
c3_share = purrr::map_dbl(crop_stats, function(cs) {
# total crop pct inside polygon
total_pct <- sum(cs$area_pct)
# sum of area_pct for all C3 crops
c3_pct <- sum(cs$area_pct[cs$code %!in% c4_codes])
# normalized C3 fraction
c3_pct / total_pct
})
)
winterwheat_sf %>%
ggplot(aes(x=wheat_share)) +
geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
theme_bw()
winterwheat_sf <- winterwheat_sf[winterwheat_sf$wheat_share >= 0.1,]
sif_monthly <- as.data.frame(winterwheat_sf) |>
mutate(
year = year(Delta_date),
month = month(Delta_date, label = TRUE, abbr = TRUE)
) |>
filter(year %in% 2017:2024, month(Delta_date) %in% 3:7) |>
group_by(NUTS_NAME, year, month) |>
summarise(
mean_sif         = mean(Daily_SIF_740nm, na.rm = TRUE),
mean_humidity    = mean(Meteo.specific_humidity, na.rm = TRUE),
mean_pressure    = mean(Meteo.surface_pressure, na.rm = TRUE),
mean_temp_skin   = mean(Meteo.temperature_skin, na.rm = TRUE),
mean_temp_2m     = mean(Meteo.temperature_two_meter, na.rm = TRUE),
mean_vpd         = mean(Meteo.vapor_pressure_deficit, na.rm = TRUE),
mean_c3_share    = mean(c3_share, na.rm = TRUE),
.groups = "drop"
)
View(sif_monthly)
X_all <- sif_monthly |>
mutate(month = as.character(month)) |>
pivot_wider(
names_from = month,
values_from = c(
mean_sif, mean_humidity, mean_pressure,
mean_temp_skin, mean_temp_2m, mean_vpd, mean_c3_share
),
names_glue = "{.value}_{month}"
)
sort(colSums(is.na(X_all)))
# List all CSV files in the folder
files <- list.files("../data/bayern_yield_formatted/", pattern = "\\.csv$", full.names = TRUE)
target_nuts <- c("Mittelfranken", "Niederbayern", "Oberbayern", "Oberfranken", "Oberpfalz", "Schwaben", "Unterfranken")
# clean column names
clean_names1 <- function(x) {
x <- iconv(x, from = "", to = "UTF-8")
x <- gsub("\\s+", " ", x)
trimws(x)
}
Y_all <- lapply(files, function(f) {
#f <- "../data/bayern_yield_formatted/2016.csv"
year <- as.numeric(str_extract(basename(f), "\\d{4}"))
y <- read.csv(f, sep = ";", fileEncoding = "latin1", stringsAsFactors = FALSE)
y <- y |> mutate(name = clean_names1(name))
names(y) <- make.names(names(y))
y <- y |>
filter(name %in% target_nuts) |>
select(name, Winterweizen) |>
mutate(year = year)
return(y)
}) |>
bind_rows()
# (German decimals use commas)
Y_all <- Y_all |> mutate(Winterweizen = as.numeric(gsub(",", ".", Winterweizen)))
XY_all <- X_all |> inner_join(Y_all, by = c("NUTS_NAME" = "name", "year" = "year"))
XY_all$Winterweizen <- XY_all$Winterweizen/10
# train test split
train_df <- XY_all |> filter(year <= 2023)
test_df  <- XY_all |> filter(year == 2024)
View(train_df)
sen2_indices <- read.csv('../data/2017_2024_nuts3_ndvi_nirv.csv')
View(sen2_indices)
sen2_indices <- sen2_indices |> select(year, month, index, nuts3_id, mean)
head(sen2_indices,3)
sen2_indices$nuts2_id <- substr(sen2_indices$nuts3_id, 1, 4)
sen2_indices
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 2, resolution = "01", country = "DE")
nuts2_de
nuts2_de <- nuts2_de |> filter(startsWith(NUTS_ID, "DE2"))
nuts2_de
sen2_indices
sen2_indices <- sen2_indices |>
left_join(nuts2_de |> st_drop_geometry() |>
select(NUTS_ID, NUTS_NAME), by = c("nuts2_id" = "NUTS_ID"))
sen2_indices |>
group_by(year, month, index, NUTS_NAME) |>
mutate(grouped_mean = mean(mean))
sen2_indices <- read.csv('../data/2017_2024_nuts3_ndvi_nirv.csv')
sen2_indices <- sen2_indices |> select(year, month, index, nuts3_id, mean)
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 2, resolution = "01", country = "DE")
nuts2_de <- nuts2_de |> filter(startsWith(NUTS_ID, "DE2"))
sen2_indices$nuts2_id <- substr(sen2_indices$nuts3_id, 1, 4)
sen2_indices <- sen2_indices |> select(-c(nuts3_id))
sen2_indices <- sen2_indices |>
left_join(nuts2_de |> st_drop_geometry() |>
select(NUTS_ID, NUTS_NAME), by = c("nuts2_id" = "NUTS_ID"))
sen2_indices |>
group_by(year, month, index, NUTS_NAME) |>
mutate(grouped_mean = mean(mean))
head(sen2_indices)
sen2_indices |>
group_by(year, month, index, NUTS_NAME) |>
summarise(mean_value = mean(mean, na.rm = TRUE), .groups = "drop")
sen2_indices <- sen2_indices |>
group_by(year, month, index, NUTS_NAME) |>
summarise(mean_value = mean(mean, na.rm = TRUE), .groups = "drop")
head(sen2_indices)
head(XY_all)
sen2_indices |>
mutate(month = tolower(month)) |>
unite("index_month", index, month, sep = "_") |>
pivot_wider(
names_from = index_month,
values_from = mean_value
) |>
arrange(NUTS_NAME, year)
sen2_wide <- sen2_indices |>
mutate(month = tolower(month)) |>
unite("index_month", index, month, sep = "_") |>
pivot_wider(
names_from = index_month,
values_from = mean_value
) |>
arrange(NUTS_NAME, year)
View(sen2_wide)
View(XY_all)
View(X_all)
head(X_all)
head(sen2_wide)
X_all <- X_all |> left_join(sen2_wide, by = c("NUTS_NAME", "year"))
sort(colSums(is.na(X_all)))
# List all CSV files in the folder
files <- list.files("../data/bayern_yield_formatted/", pattern = "\\.csv$", full.names = TRUE)
target_nuts <- c("Mittelfranken", "Niederbayern", "Oberbayern", "Oberfranken", "Oberpfalz", "Schwaben", "Unterfranken")
# clean column names
clean_names1 <- function(x) {
x <- iconv(x, from = "", to = "UTF-8")
x <- gsub("\\s+", " ", x)
trimws(x)
}
Y_all <- lapply(files, function(f) {
#f <- "../data/bayern_yield_formatted/2016.csv"
year <- as.numeric(str_extract(basename(f), "\\d{4}"))
y <- read.csv(f, sep = ";", fileEncoding = "latin1", stringsAsFactors = FALSE)
y <- y |> mutate(name = clean_names1(name))
names(y) <- make.names(names(y))
y <- y |>
filter(name %in% target_nuts) |>
select(name, Winterweizen) |>
mutate(year = year)
return(y)
}) |>
bind_rows()
# (German decimals use commas)
Y_all <- Y_all |> mutate(Winterweizen = as.numeric(gsub(",", ".", Winterweizen)))
XY_all <- X_all |> inner_join(Y_all, by = c("NUTS_NAME" = "name", "year" = "year"))
XY_all$Winterweizen <- XY_all$Winterweizen/10
install.packages("arrow")
arrow::write_parquet(XY_all, "../data/model_data_all.parquet")
XY_all <- arrow::read_parquet("../data/model_data_all.parquet")
View(XY_all)
56*46
sen2_indices <- read.csv('../data/2017_2024_nuts3_ndvi_nirv.csv')
sen2_indices <- sen2_indices |> select(year, month, index, nuts3_id, mean)
sen2_indices
# List all CSV files in the folder
files <- list.files("../data/bayern_yield_formatted/", pattern = "\\.csv$", full.names = TRUE)
target_nuts <- c("Mittelfranken", "Niederbayern", "Oberbayern", "Oberfranken", "Oberpfalz", "Schwaben", "Unterfranken")
# clean column names
clean_names1 <- function(x) {
x <- iconv(x, from = "", to = "UTF-8")
x <- gsub("\\s+", " ", x)
trimws(x)
}
Y_all <- lapply(files, function(f) {
#f <- "../data/bayern_yield_formatted/2016.csv"
year <- as.numeric(str_extract(basename(f), "\\d{4}"))
y <- read.csv(f, sep = ";", fileEncoding = "latin1", stringsAsFactors = FALSE)
y <- y |> mutate(name = clean_names1(name))
names(y) <- make.names(names(y))
y <- y |>
#filter(name %in% target_nuts) |>
select(name, Winterweizen) |>
mutate(year = year)
return(y)
}) |>
bind_rows()
View(Y_all)
# (German decimals use commas)
Y_all <- Y_all |> mutate(Winterweizen = as.numeric(gsub(",", ".", Winterweizen)))
nuts3_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 3, resolution = "01", country = "DE")
View(nuts3_de)
nuts3_de <- nuts3_de |> filter(startsWith(NUTS_ID, "DE2"))
length(unique(Y_all$name))
length(unique(nuts3_de$NAME_LATN))
unique(Y_all$name)
writeLines(unique(Y_all$name), con = "bavstat.txt")
write.csv(matrix(unique(Y_all$name), nrow = 1), file = "bavstat.csv", row.names = FALSE)
nuts3_de
nuts3_de |> st_drop_geometry() |> select(NUTS_ID, NUTS_NAME)
writeLines(unique(Y_all$name), con = "bavstat.txt")
write.csv(nuts3_de |> st_drop_geometry() |> select(NUTS_ID, NUTS_NAME),
file = "nuts3.csv", row.names = FALSE)
nuts3_de |> st_drop_geometry() |> select(NUTS_ID, NUTS_NAME)
unique(Y_all$name)
Y_all |>
mutate(
NUTS_NAME = name |>
str_replace("\\(Krfr\\.St\\)", ", Kreisfreie Stadt") |>
str_replace("\\(Lkr\\)", ", Landkreis") |>
str_trim()
)
Y_all |>
mutate(
NUTS_NAME = name |>
str_replace("\\(Krfr\\.St\\)", ", Kreisfreie Stadt") |>
str_replace("\\(Lkr\\)", ", Landkreis") |>
str_trim() |>
str_replace_all(NUTS_NAME, "\\s+,", ",")
)
Y_all |>
mutate(
NUTS_NAME = name |>
str_replace("\\(Krfr\\.St\\)", ", Kreisfreie Stadt") |>
str_replace("\\(Lkr\\)", ", Landkreis") |>
str_trim() |>
str_replace_all("\\s+,", ",")
)
Y_all <- Y_all |>
mutate(
NUTS_NAME = name |>
str_replace("\\(Krfr\\.St\\)", ", Kreisfreie Stadt") |>
str_replace("\\(Lkr\\)", ", Landkreis") |>
str_trim() |>
str_replace_all("\\s+,", ",")
)
unique(Y_all$name)
unique(Y_all$NUTS_NAME)
unclean_names <- unique(Y_all$NUTS_NAME)
unclean_names <- unclean_names[!unclean_names %in% regions_to_remove]
regions_to_remove <- c(
"Bayern", "Oberbayern", "Niederbayern", "Oberpfalz",
"Oberfranken", "Mittelfranken", "Unterfranken", "Schwaben"
)
unclean_names <- unclean_names[!unclean_names %in% regions_to_remove]
writeLines(unclean_names, con = "bavstat.txt")
write.csv(nuts3_de |> st_drop_geometry() |> select(NUTS_ID, NUTS_NAME),
file = "nuts3.csv", row.names = FALSE)
sort(unclean_names)
sort(nuts3_de |> st_drop_geometry() |> select(NUTS_NAME))
nuts3_de |> st_drop_geometry() |> select(NUTS_NAME)
clean_names <- nuts3_de |> st_drop_geometry() |> select(NUTS_NAME)
clean_names
sort(clean_names)
clean_names <- nuts3_de |> st_drop_geometry() |> select(NUTS_NAME) |> arrange(NUTS_NAME)
clean_names
clean_names <- nuts3_de |> st_drop_geometry() |> select(NUTS_NAME, NUTS_ID) |> arrange(NUTS_NAME)
clean_names
sort(unclean_names)
clean_names$bad_names <- sort(unclean_names)
View(clean_names)
clean_names |> select(NUTS_ID, NUTS_NAME)
writeLines(sort(unclean_names), con = "bavstat.txt")
write.csv(clean_names |> select(NUTS_ID, NUTS_NAME), file = "nuts3.csv", row.names = FALSE)
View(clean_names)
#writeLines(sort(unclean_names), con = "bavstat.txt")
write.csv(clean_names, file = "nuts3.csv", row.names = FALSE)
match_table <- read.csv('nuts3_cleaned.csv')
View(match_table)
View(Y_all)
head(Y_all)
head(match_table)
colnames(Y_all)
colnames(Y_all) <- c("name","Winterweizen","year","bad_names")
head(Y_all)
head(match_table)
Y_all |>
left_join(match_table |> select(bad_names, NUTS_ID, NUTS_NAME), by = "bad_names")
Y_all <- Y_all |>
left_join(match_table |> select(bad_names, NUTS_ID, NUTS_NAME), by = "bad_names")
unique(Y_all$NUTS_NAME)
Y_all |> drop_na()
colSums(is.na(Y_all))
Y_final <- Y_all |> drop_na()
936-274
colSums(is.na(Y_final))
View(Y_final)
View(sen2_indices)
saveRDS(Y_final, file = 'y_final_sen2.rds')
head(sen2_indices)
sen2_indices |>
mutate(month = tolower(month)) |>
unite("index_month", index, month, sep = "_") |>
pivot_wider(
names_from = index_month,
values_from = mean_value
) |>
arrange(nuts3_id, year)
sen2_indices |>
mutate(month = tolower(month)) |>
unite("index_month", index, month, sep = "_") |>
pivot_wider(
names_from = index_month,
values_from = mean
) |>
arrange(nuts3_id, year)
sen2_wide <- sen2_indices |>
mutate(month = tolower(month)) |>
unite("index_month", index, month, sep = "_") |>
pivot_wider(
names_from = index_month,
values_from = mean
) |>
arrange(nuts3_id, year)
View(sen2_wide)
XY_all <- sen2_wide |> inner_join(Y_final, by = c("nuts3_id" = "NUTS_ID", "year" = "year"))
View(XY_all)
View(sen2_indices)
colSums(is.na(XY_all))
arrow::write_parquet(XY_all, "../data/model_data_sen2.parquet")
XY_all <- arrow::read_parquet("../data/model_data_sen2.parquet")
