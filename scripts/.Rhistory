# model summary
summary(model)
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df[, -c(1,2,38)])
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield, pct_diff)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
#test_df <- test_df %>% drop_na(SIF_Feb, SIF_Mar, SIF_Apr, SIF_May)
test_df$predicted_yield <- predict(model, newdata = test_df)
test_df <- test_df |>
mutate(
predicted_yield = predict(model, newdata = test_df),
pct_diff = 100 * (predicted_yield - Winterweizen) / Winterweizen
)
test_df |> select(NUTS_NAME, year, Winterweizen, predicted_yield, pct_diff)
# rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
# rmse
rmse <- sqrt(mean((test_df$predicted_yield - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
#----------------------------------glmnet----------------------------
library(glmnet)
library(tidyverse)
library(mice)
X <- model.matrix(Winterweizen ~ ., data = train_complete)[, -1]  # drop intercept column
X
X <- model.matrix(Winterweizen ~ ., data = train_complete)[, -1]  # drop intercept column
y <- train_complete$Winterweizen
set.seed(123)
cv_fit <- cv.glmnet(
x      = X,
y      = y,
alpha  = 1,      # 1 = lasso, 0 = ridge, in between = elastic net
nfolds = 5       # you can use 10, but with ~50 obs 5 is fine
)
## 5. Inspect results
plot(cv_fit)                           # CV curve vs log(lambda)
cv_fit$lambda.min                      # lambda with minimum CV error
cv_fit$lambda.1se                      # more regularized lambda
## 6. Coefficients at best lambda
coef_min  <- coef(cv_fit, s = "lambda.min")
coef_1se  <- coef(cv_fit, s = "lambda.1se")
coef_min
coef_1se
train_complete
glm_train <- train_complete %>% select(-c(NUTS_NAME, year))
X <- model.matrix(Winterweizen ~ ., data = glm_train)[, -1]  # drop intercept column
y <- train_complete$Winterweizen
X
set.seed(123)
cv_fit <- cv.glmnet(
x      = X,
y      = y,
alpha  = 1,      # 1 = lasso, 0 = ridge, in between = elastic net
nfolds = 5       # you can use 10, but with ~50 obs 5 is fine
)
## 5. Inspect results
plot(cv_fit)                           # CV curve vs log(lambda)
glm_test <- test_df %>% select(-c(NUTS_NAME, year))
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
X_test
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
test_df  <- XY_all |> filter(year == 2024)
glm_test <- test_df %>% select(-c(NUTS_NAME, year))
X_test <- model.matrix(Winterweizen ~ ., data = glm_test)[, -1]
y_pred <- predict(cv_fit, newx = X_test, s = "lambda.min")
test_df %>% mutate(pred_Winterweizen = as.numeric(y_pred))
test_df %>% mutate(pred_Winterweizen = as.numeric(y_pred)) %>% select(NUTS_NAME, pred_Winterweizen, Winterweizen)
test_df %>% mutate(
pred_Winterweizen = as.numeric(y_pred),
pct_diff = 100 * (pred_Winterweizen - Winterweizen) / Winterweizen) %>%
select(NUTS_NAME, pred_Winterweizen, Winterweizen, pct_diff)
test_df <- test_df %>% mutate(
pred_Winterweizen = as.numeric(y_pred),
pct_diff = 100 * (pred_Winterweizen - Winterweizen) / Winterweizen) %>%
select(NUTS_NAME, pred_Winterweizen, Winterweizen, pct_diff)
rmse <- sqrt(mean((test_df$pred_Winterweizen - test_df$Winterweizen)^2, na.rm = TRUE))
rmse
rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$predicted_yield - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
rmse <- sqrt(mean((test_df[test_df$NUTS_NAME != 'Oberfranken',]$pred_Winterweizen - test_df[test_df$NUTS_NAME != 'Oberfranken',]$Winterweizen)^2, na.rm = TRUE))
rmse
library(tidyverse)
library(terra)
library(sf)
library(rnaturalearth)
ndvi <- rast("../data/copernicus_ndvi_300m/NDVI_20250201T000000Z.tif")
nuts1_de <- giscoR::gisco_get_nuts(
year    = "2021",
epsg    = 4326,
resolution = "3",
nuts_level = 1,
country = "DE"
)
nuts1_de <- st_transform(nuts1_de, crs(ndvi))
nuts2_de <- giscoR::gisco_get_nuts(
year    = "2021",
epsg    = 4326,
resolution = "3",
nuts_level = 2,
country = "DE"
)
nuts2_de <- st_transform(nuts2_de, crs(ndvi))
tile_vec <- c(
"32UNA", "32UPA", "32UQA",
"32UNV", "32UPV", "32UQV", "33UUQ",
"32UNU", "32UPU", "32UQU", "33UUP",
"32TNT", "32TPT", "32TQT"
)
base_dir <- "../data/sentinel-2-tiles/"
b4_files <- list.files(base_dir, pattern = "FRC_B4\\.tif$", full.names = TRUE, recursive = TRUE)
length(b4_files)
common_crs <- 4326  # EPSG:3035 / 4326
bbox_list <- lapply(b4_files, function(f) {
r <- terra::rast(f)
ext <- terra::ext(r)
poly <- terra::as.polygons(ext, crs = terra::crs(r))
sf_poly <- sf::st_as_sf(poly)
sf_poly <- sf::st_transform(sf_poly, common_crs)
sf_poly$tile_file <- basename(f)
sf_poly$tile_id   <- sub(".*_L3A_T(.*)_C.*", "\\1", sf_poly$tile_file)
sf_poly
})
tiles_sf <- do.call(rbind, bbox_list)
tiles_sf$tile_id <- factor(tiles_sf$tile_id, levels = tile_vec)
tiles_sf <- tiles_sf[order(tiles_sf$tile_id), ]
target_crs <- st_crs(tiles_sf)
nuts1_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 1,
resolution = "01", country = "DE")
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 3,
resolution = "01", country = "DE")
nuts2_centroids <- sf::st_centroid(nuts2_de)
# nuts1_de <- st_transform(nuts1_de, target_crs)
View(tiles_sf)
View(nuts1_de)
View(nuts2_de)
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_sf(data = tiles_sf, aes(color = tile_id, fill = tile_id), linewidth = 0.8, alpha = 0.3 ) +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
theme_minimal() +
labs(title = "14 tiles covering bavaria", x = "Lon", y = "Lat") +
# --- labels for NUTS level 3 ---
geom_sf_text(
data = nuts2_centroids,
aes(label = NUTS_ID),   # or NUTS_NAME, depending on the column you want
size = 2.5,
check_overlap = TRUE
) +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
theme_minimal() +
labs(
title = "14 tiles covering Bavaria",
x = "Lon",
y = "Lat"
)
library(tidyverse)
library(sf)
library(mice)
result_all <- readRDS(file = '../data/model_data.rds')
idx <- sapply(result_all$crop_stats, function(df) {
if (is.null(df) || nrow(df) == 0) return(FALSE)
any(df$code == "winter_wheat" & df$area_pct >= 10, na.rm = TRUE)
})
# get the polygons with x pct wheat
winterwheat_sf <- result_all[idx,]
c4_codes <- c("maize")
`%!in%` <- Negate(`%in%`)
winterwheat_sf <- winterwheat_sf %>%
mutate(
wheat_share = purrr::map_dbl(crop_stats, function(cs) {
wheat_row <- cs[cs$code == "winter_wheat", ]
wheat_pct <- wheat_row$area_pct
total_pct <- sum(cs$area_pct)
wheat_pct / total_pct
}),
c3_share = purrr::map_dbl(crop_stats, function(cs) {
# total crop pct inside polygon
total_pct <- sum(cs$area_pct)
# sum of area_pct for all C3 crops
c3_pct <- sum(cs$area_pct[cs$code %!in% c4_codes])
# normalized C3 fraction
c3_pct / total_pct
})
)
View(winterwheat_sf)
head(winterwheat_sf %>% select(-c(crop_stats)))
head(winterwheat_sf %>% select(-c(crop_stats)),1)
winterwheat_sf %>%
mutate(
centroid = st_centroid(geometry),
center_lon = st_coordinates(centroid)[,1],
center_lat = st_coordinates(centroid)[,2]
) %>%
select(-centroid)
winterwheat_sf %>%
mutate(
geometry = st_make_valid(geometry),
centroid = st_centroid(geometry),
center_lon = st_coordinates(centroid)[, 1],
center_lat = st_coordinates(centroid)[, 2]
) %>%
select(-centroid)
winterwheat_sf %>%
mutate(
geometry = st_make_valid(geometry),
centroid = st_centroid(geometry),
center_lon = st_coordinates(centroid)[, 1],
center_lat = st_coordinates(centroid)[, 2]
) %>%
select(-centroid)
winterwheat_sf$geometry <- st_make_valid(winterwheat_sf$geometry)
winterwheat_sf %>%
mutate(
centroid = st_centroid(geometry),
center_lon = st_coordinates(centroid)[,1],
center_lat = st_coordinates(centroid)[,2]
) %>%
select(-centroid)
winterwheat_sf %>%
mutate(
centroid = st_centroid(geometry),
center_lon = st_coordinates(centroid)[,1],
center_lat = st_coordinates(centroid)[,2]
) %>%
select(-centroid)
View(winterwheat_sf)
winterwheat_sf <- winterwheat_sf %>%
mutate(
center_lat = (Lat_corner1 + Lat_corner2 + Lat_corner3 + Lat_corner4) / 4,
center_lon = (Lon_corner1 + Lon_corner2 + Lon_corner3 + Lon_corner4) / 4
)
View(winterwheat_sf)
head(winterwheat_sf %>% select(-c(crop_stats)),1)
winterwheat_sf[,1]
winterwheat_sf[1,]
ggplot() +
geom_sf(data = winterwheat_sf[1,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[1,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = winterwheat_sf[4,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[4,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = winterwheat_sf[4,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[4,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = winterwheat_sf[1:4,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[1:4,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = winterwheat_sf[1:100,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
nuts1_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 1, resolution = "01", country = "DE")
nuts2_de <- giscoR::gisco_get_nuts(year = "2021", epsg = 4326, nuts_level = 3, resolution = "01", country = "DE")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_sf(data = winterwheat_sf[1:100,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_sf(data = winterwheat_sf[1:100,], fill = NA, color = "navyblue", size = 1) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 3) +
theme_minimal() +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_minimal() +
coord_sf(xlim = c(8, 15), ylim = c(46.5, 51), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_minimal() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf[1:100,], aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts2_de, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf, aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
View(nuts2_de)
nuts3_bavaria <- nuts2_de |> filter(startsWith(NUTS_ID, "DE2"))
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf, aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
View(winterwheat_sf)
View(winterwheat_sf[[21]][[180214]])
View(winterwheat_sf[[21]][[180214]])
View(winterwheat_sf[[21]][[180244]])
View(winterwheat_sf[[21]][[205080]])
View(winterwheat_sf)
View(winterwheat_sf[[21]][[135150]])
View(winterwheat_sf[[21]][[88551]])
View(winterwheat_sf[[21]][[133767]])
View(winterwheat_sf[[21]][[157824]])
View(winterwheat_sf)
View(winterwheat_sf[[21]][[6027]])
high_ww <- winterwheat_sf[winterwheat_sf$wheat_share > 0.8,]
View(high_ww)
View(high_ww[[21]][[108837]])
high_ww
View(high_ww[[21]][[88545]])
View(high_ww[[21]][[166107]])
View(winterwheat_sf)
View(winterwheat_sf[[21]][[6197]])
View(high_ww)
View(high_ww[[21]][[108876]])
high_ww$crop_stats
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = high_ww, aes(x = center_lon, y = center_lat),color = "firebrick",size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
lubridate::month(winterwheat_sf$Delta_Time)
winterwheat_sf$month <- lubridate::month(winterwheat_sf$Delta_Time)
winterwheat_sf$year <- lubridate::year(winterwheat_sf$Delta_Time)
high_ww <- winterwheat_sf[winterwheat_sf$wheat_share > 0.8,]
winterwheat_sf |> filter(year == 2017)
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017), aes(x = center_lon, y = center_lat, color = month),size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
g
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017), aes(x = center_lon, y = center_lat, color = factor(month)),size = 1) +
theme_bw() +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude")
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017), aes(x = center_lon, y = center_lat, color = factor(month)),size = 1) +
theme_bw() +
scale_color_brewer(name = "Month",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017),
aes(x = center_lon, y = center_lat, color = factor(month)),size = 1, alpha=0.5) +
theme_bw() +
scale_color_brewer(name = "Month",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017),
aes(x = center_lon, y = center_lat, color = factor(month)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Month",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12), legend.text = element_text(size = 10))
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf |> filter(year == 2017),
aes(x = center_lon, y = center_lat, color = factor(month)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Month",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
axis.ticks = element_blank())
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = winterwheat_sf,
aes(x = center_lon, y = center_lat, color = factor(year)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Year",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
axis.ticks = element_blank())
result_all <- readRDS(file = '../data/model_data.rds')
idx <- sapply(result_all$crop_stats, function(df) {
if (is.null(df) || nrow(df) == 0) return(FALSE)
any(df$code == "winter_wheat" & df$area_pct >= 0, na.rm = TRUE)
})
# get the polygons with x pct wheat
winterwheat_sf <- result_all[idx,]
c4_codes <- c("maize")
`%!in%` <- Negate(`%in%`)
winterwheat_sf <- winterwheat_sf |>
mutate(
wheat_share = purrr::map_dbl(crop_stats, function(cs) {
wheat_row <- cs[cs$code == "winter_wheat", ]
wheat_pct <- wheat_row$area_pct
total_pct <- sum(cs$area_pct)
wheat_pct / total_pct
}),
c3_share = purrr::map_dbl(crop_stats, function(cs) {
# total crop pct inside polygon
total_pct <- sum(cs$area_pct)
# sum of area_pct for all C3 crops
c3_pct <- sum(cs$area_pct[cs$code %!in% c4_codes])
# normalized C3 fraction
c3_pct / total_pct
})
)
winterwheat_sf %>%
ggplot(aes(x=wheat_share)) +
geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
theme_ipsum()
winterwheat_sf %>%
ggplot(aes(x=wheat_share)) +
geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
theme_bw()
winterwheat_sf <- winterwheat_sf |>
mutate(
center_lat = (Lat_corner1 + Lat_corner2 + Lat_corner3 + Lat_corner4) / 4,
center_lon = (Lon_corner1 + Lon_corner2 + Lon_corner3 + Lon_corner4) / 4
)
winterwheat_sf$month <- lubridate::month(winterwheat_sf$Delta_Time)
winterwheat_sf$year <- lubridate::year(winterwheat_sf$Delta_Time)
high_ww <- winterwheat_sf[winterwheat_sf$wheat_share > 0.25,]
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = high_ww,
aes(x = center_lon, y = center_lat, color = factor(year)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Year",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
axis.ticks = element_blank())
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = high_ww |> filter(year != 2024),
aes(x = center_lon, y = center_lat, color = factor(year)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Year",palette = "Set1") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
axis.ticks = element_blank())
ggplot() +
geom_sf(data = nuts1_de, fill = NA, color = "blue", linewidth = 1) +
geom_sf(data = nuts3_bavaria, fill = NA, color = "black", linewidth = 0.4) +
geom_point(data = high_ww |> filter(year != 2024),
aes(x = center_lon, y = center_lat, color = factor(month)),size = 1, alpha=0.8) +
theme_bw() +
scale_color_brewer(name = "Month",palette = "Set2") +
coord_sf(xlim = c(8.8, 14), ylim = c(47, 50.7), expand = FALSE) +
labs(x = "Longitude", y = "Latitude") +
guides(color = guide_legend(override.aes = list(size = 4))) +
theme(legend.title = element_text(size = 12),
legend.text = element_text(size = 10),
axis.ticks = element_blank())
